/*QuoteME (2.0.0) by Cédric CLAERHOUT - Licence: CC by*/
if(typeof Sedo=="undefined")var Sedo={};!function(n,t,i,r){function f(n,t){XenForo.register(n,t)}Sedo.QuoteME={isOn:!0,isTrans:!1,QM:"#QuoteMe",QMT:"#QuoteMeTrigger",QME:"#QuoteMeEl",editorID:"ctrl_message_html",isRte:!1,isRteBbCode:!1,isTinyMCE:!1,isRedactor:!1,editorType:"notRte",redactor:"",srcType:"txt",init:function(t){var u=Sedo.QuoteME,c=n(u.QM),o=n.proxy(u,"_initPressDown"),h=n.proxy(u,"_initPressUp"),s=n.proxy(u,"_initQmClick"),f,e;u.$element=t,u.addEventSupport=i.addEventListener!=r,u.eventTypeDown=null,f="touchstart mousedown",n("body:not("+u.QM+")").unbind(f,o).bind(f,o),u.eventTypeUp=null,e="qm_ready mouseup",t.not(u.QM).unbind(e,h).bind(e,h),c.unbind("touchstart click",s).bind("touchstart click",s)},_initPressDown:function(t){var u=this,e=n(u.QM),f=t.type=="mousedown",o=f&&t.which==1,s=f&&t.which!=1;if((u.eventTypeDown==r||u.eventTypeDown==t.type)&&(u.eventTypeDown=t.type,u.isOn)&&(u.getSelectedText(),u.SelectedText&&(o||!f)&&u.unSelect(),t.target.id!="QuoteMe")){if(e.is(":visible")&&(o||!f)){u.unSelect(),e.hide();return}if(s){e.hide();return}!f&&u.addEventSupport&&(u._moveReset(),i.addEventListener("touchmove",u._moveRec,!1),i.addEventListener("selectionchange",u._touchSelec,!1))}},_initPressUp:function(t){var i=this,u=n(i.QM),e=t.type=="mouseup",p=e&&t.which==1,w=e&&t.which!=1,f=u.data("pos"),l,o,h,c,a;if((i.eventTypeUp==r||i.eventTypeUp==t.type)&&(i.eventTypeUp=t.type,i.isOn)){if(!e&&i.addEventSupport){var y=i.selectionHasChanged,v=i.lastMove,s="touch";if(v&&v.changedTouches!=r&&(f=s),!y||i.SelectedText==r){u.hide();return}}if(u.is(":hidden")&&(p||!e)){if(l=i.config(t.currentTarget),l===!1){u.hide();return}if(f=="absfix")if(o=n(t.target).parents(".messageContent").position(),h=n(t.target).parents(".messageContent").offset(),h==null||o==null)f="fb";else{c=Math.round(t.pageY-(h.top-o.top))+1+"px",a=t.pageX+"px",u.show().css({position:"absolute",left:a,top:c});return}f=="abs"?u.css({position:"absolute",left:t.pageX+1+"px",top:t.pageY+1+"px"}):f==s?u.addClass(s):u.css({position:"fixed",left:t.clientX+1+"px",top:t.clientY+1+"px"}),u.show();return}w}},_initQmClick:function(t){t.preventDefault();var i=this,r=n(i.QM);i.SelectedMode=="txt"?i.execute(i.SelectedText):i.SelectedText&&XenForo.ajax("index.php?quoteme/to-tiny",{htmlraw:i.SelectedText},n.proxy(i,"rawHtml2cleanHtml")),r.hide();return},_touchSelec:function(){var i=Sedo.QuoteME,r=n(i.QM);r.hide(),i.getSelection(),i.SelectedText&&i.SelectedText.length>1&&(i.selectionHasChanged=!0,i.$element.trigger("qm_ready"))},_moveRec:function(n){var t=Sedo.QuoteME;t.lastMove=n},_moveReset:function(n){var t=this;n==!0&&(i.removeEventListener("touchmove",t._moveRec,!1),i.removeEventListener("selectionchange",t._touchSelec,!1),t.lastMove=null),t.selectionHasChanged=!1},getParams:function(){var t=this,f=n("#"+t.editorID),u=f.data("redactor"),i;typeof tinyMCE!="undefined"&&(this.isTinyMCE=!0,this.isRte=!0),u!==r&&u!==null&&(this.isRedactor=!0,this.redactor=u,this.isRte=!0),this.isRteBbCode=this.isRte==!0&&f.attr("disabled")?!0:!1,this.isRte==!0&&(this.editorType=this.isRteBbCode==!0?"rteBB":"rteFull"),this.srcType=this.editorType=="rteFull"?"html":"txt",i=n(t.QM),t.Mode=i.data("mode"),t.HtmlMode=0,t.Mode!="QmText"&&(t.HtmlMode=parseInt(i.data("html"))),t.isTrans=parseInt(i.data("trans"))?!0:!1},config:function(t){var i=this,u;i.getParams();switch(i.Mode){case"QmText":i.Mode="txt",i.checkHtml=!1;break;case"QmHtml":i.Mode="html",i.checkHtml=!0;break;default:i.Mode="htmlwrap",i.checkHtml=!0}return(i.getSelection(),!i.SelectedText)?!1:i.Mode!="txt"&&i.SelectedText.match(/<(\w+)(?:[^>]+?)?><\/\1>|<embed[^>]+?>/i)?!1:(u=n(t).parents(".message"),i.Author=u.data("author"),i.MessageID=u.attr("id"),i.AuthorID=u.attr("data-author-id"),i.AuthorID=i.AuthorID?", member: "+i.AuthorID:"",i.MessageID==r?(i.MessageType="",i.MessageID=""):i.MessageID.match(/post-/i)?(i.MessageType="post",i.MessageID=i.MessageID.replace(/post-/i,"")):i.MessageID.match(/message-/i)&&(i.MessageType="convMessage",i.MessageID=i.MessageID.replace(/message-/i,"")),!0)},getSelection:function(){var n=this;n.checkHtml===!0&&n.editorType=="rteFull"?(n.SelectedMode="html",n.SelectedText=n.getSelectedTextHtml()):(n.SelectedMode="txt",n.SelectedText=n.getSelectedText())},execute:function(n){var t=this;t.HtmlMode==1&&(n=n.replace(/^<p>([\s\S]+)<\/p>$/i,"$1")),n=t.Author&&t.MessageID&&t.MessageType?'[quote="'+t.Author+", "+t.MessageType+": "+t.MessageID+t.AuthorID+'"]'+n+"[/quote]":"[quote]"+n+"[/quote]",t.SelectedText=n,t.isTrans?t.transMode():(t.prepareSel(),t.edDispatcher())},edDispatcher:function(){var n=this;console.info("Editor mode: "+n.editorType+", Text mode: "+n.Mode);switch(n.editorType){case"rteBB":n.RTE_BBcodeEditor();break;case"rteFull":n.RTE_Wysiwyg();break;case"notRte":n.notRTE_BBcodeEditor()}},transMode:function(){var t=this,i=t.getObjQM(),u=t.SelectedText,r=1,f=t.editorType=="rteFull"?"html":"txt";i?r=t.getObjIdx(i):i={},i[r]={data:u,type:t.srcType},t.setObjQM(i),n(t.QMT).parent().show(),n(t.QME).text(r)},transAction:function(){var t=this,r,i;(t.getParams(),r=t.getObjQM(),i="",r)&&(n.each(r,function(n,r){t.SelectedText=r.data,t.prepareSel(r.type),i+=t.SelectedText}),t.SelectedText=i,t.edDispatcher(),n(t.QMT).parent().hide(),t.killObjQM())},prepareSel:function(n){var i=this,t=i.SelectedText,o=i.srcType,u,e,f;if(n===r&&(n=o),o=="txt"){n!="txt"&&(t=t.replace(/<[^>]+>/ig,""),t=i.unescapeHtml(t)),$editor=i.getBbCodeEditor(),f=$editor.val(),u=f?"\r\n":"",i.SelectedText=u+t+"\r\n";return}this.isTinyMCE&&(u=tinyMCE.isIE?"<p>&nbsp;</p>":"<p><br /></p>",e=u,f=tinyMCE.activeEditor.getContent()),this.isRedactor&&(u=this.redactor.browser("msie")?"<p>&nbsp;</p>":"<p><br /></p>",e=u,f=this.redactor.getCode()),f=f.replace(/<[^>]+>|&nbsp;/ig,""),f||(u=""),i.HtmlMode==0&&n=="html"&&(t=i.escapeHtml(t)),n!="html"&&(t=i.escapeHtml(t)),i.SelectedText=u+"<p>"+t+"</p>"+e},notRTE_BBcodeEditor:function(){$editor=this.getBbCodeEditor(),$editor.val($editor.val()+this.SelectedText)},RTE_BBcodeEditor:function(){$editor=this.getBbCodeEditor(),$editor.val($editor.val()+this.SelectedText)},RTE_Wysiwyg:function(){var n=this,r=n.editorID,t=n.SelectedText,i;n.isTinyMCE?tinyMCE.majorVersion>3?(i={skip_focus:!0},tinyMCE.EditorManager.get(r).execCommand("mceInsertContent",!1,t,i)):tinyMCE.getInstanceById(r).execCommand("mceInsertContent",!1,t):n.isRedactor&&n.redactor.insertHtml(t)},getBbCodeEditor:function(t){var r=this,i=t||r.editorType;switch(i){case"rteBB":return n(".bbCodeEditorContainer").find("textarea.textCtrl");case"notRte":return n(".textCtrl.MessageEditor");default:return console.info("Bb Editor not found"),n()}},unSelect:function(){i.selection?i.selection.empty():t.getSelection&&t.getSelection().removeAllRanges()},getSelectedText:function(){return t.getSelection?t.getSelection().toString():i.getSelection?i.getSelection():i.selection?i.selection.createRange().text:void 0},getSelectedTextHtml:function(){var o=this,n,e,u,s,f;if(t.getSelection!=r){if(n=t.getSelection(),n.rangeCount){for(e=i.createElement("div"),u=0,s=n.rangeCount;u<s;++u)e.appendChild(n.getRangeAt(u).cloneContents());return o.Mode=="htmlwrap"&&n.anchorNode.parentNode.outerHTML?(f=n.anchorNode.parentNode.parentElement.outerHTML.replace(/(^<[^>]+?>)([\s\S]+)(<[^>]+?>$)/,"$1{target}$3"),f.replace("{target}",e.innerHTML)):e.innerHTML}}else if(i.selection!=r&&i.selection.type=="Text")return o.Mode=="htmlwrap"&&i.selection.createRange().parentElement().outerHTML?(f=i.selection.createRange().parentElement().outerHTML.replace(/(<[^>]+?>)([\s\S]+)(<[^>]+?>)/,"$1{target}$3"),f.replace("{target}",i.selection.createRange().htmlText)):i.selection.createRange().htmlText},rawHtml2cleanHtml:function(n){this.execute(n.tinyCode);return},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"),t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)</p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n},menuInit:function(n){var u=Sedo.QuoteME,i,f=n.data("title"),e=n.data("off"),t;if(n.data("show")||XenForo.isTouchBrowser())u.isOn=!1;else return;if(n.show().click(function(t){t.preventDefault(),n.hasClass("off")?(n.removeClass("off").addClass("on"),u.isOn=!0):(n.removeClass("on").addClass("off"),u.isOn=!1)}),t=n.data("tooltip"),t!==r)t.onBeforeShow(function(){i=n.hasClass("off")?f:e,this.getTip().text(i)})},getObjQM:function(){return n.jStorage.get("quoteme",!1)},setObjQM:function(t){n.jStorage.set("quoteme",t,{TTL:6e5})},killObjQM:function(){n.jStorage.deleteKey("quoteme")},getObjIdx:function(t){var i=1;return n.each(t,function(){i++}),i},transTrigger:function(t){var i=Sedo.QuoteME,r,u;($QM=n(i.QM),i.isTrans=parseInt($QM.data("trans")),i.isTrans)&&(r=i.getObjQM(),r!==!1&&(t.trigger("click"),u=i.getObjIdx(r),t.parent().show(),n(i.QME).text(u-1)),t.click(function(n){n.preventDefault(),i.transAction()}))}};var u="Sedo.QuoteME";f("#toggleMeMenu",u+".menuInit"),f("#QuoteMeTrigger",u+".transTrigger"),f(".messageContent",u+".init"),f(".quoteMeContent",u+".init")}(jQuery,this,document);