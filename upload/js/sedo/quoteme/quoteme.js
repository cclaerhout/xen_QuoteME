!function(n,t,i){XenForo.QuoteME={iC:0,init:function(t){var i=XenForo.QuoteME;n("body:not(#QuoteMe)").bind("mousedown",function(t){if(XenForo.QuoteME.getSelectedText(),i.SelectedText&&t.which==1&&XenForo.QuoteME.unSelect(),t.target.id!="QuoteMe"){if(n("#QuoteMe").is(":visible")&&t.which==1){XenForo.QuoteME.unSelect(),n("#QuoteMe").hide();return}if(t.which!=1){n("#QuoteMe").hide();return}}}),t.not("#QuoteMe").bind("mouseup",function(t){var u,r;if(i.iC=0,n("#QuoteMe").is(":hidden")&&t.which==1){if(u=XenForo.QuoteME.config(this),u===!1){n("#QuoteMe").hide();return}if(r=n("#QuoteMe").attr("data-pos"),r=="absfix"){var o=n(t.target).parents(".messageContent").position(),s=n(t.target).parents(".messageContent").offset(),f=Math.round(t.pageY-(s.top-o.top))+1+"px",e=t.pageX+"px";n("#QuoteMe").show().css({position:"absolute",left:e,top:f})}else r=="abs"?n("#QuoteMe").show().css({position:"absolute",left:t.pageX+1+"px",top:t.pageY+1+"px"}):n("#QuoteMe").show().css({position:"fixed",left:t.clientX+1+"px",top:t.clientY+1+"px"});return}t.which!=1}),n("#QuoteMe").bind("click",function(){if(!(i.iC>0)){i.iC++,i.SelectedMode=="text"?XenForo.QuoteME.execute(i.SelectedText):i.SelectedText&&XenForo.ajax("index.php?quoteme/to-tiny",{htmlraw:i.SelectedText},XenForo.QuoteME.rawHtml2cleanHtml),n("#QuoteMe").hide();return}})},config:function(t){var i=this;i.editor="notRte",typeof tinyMCE!="undefined"&&($bbcodeEditor=n(".bbCodeEditorContainer"),i.editor=$bbcodeEditor.length!=0?"isRte_Bbcode":"isRte_Full"),i.Mode=n("#QuoteMe").attr("data-mode"),i.Mode!="QmText"&&(i.HtmlMode=parseInt(n("#QuoteMe").attr("data-html")));switch(i.Mode){case"QmText":i.Mode="text",i.checkHtml=!1;break;case"QmHtml":i.Mode="html",i.checkHtml=!0;break;default:i.Mode="htmlwrap",i.checkHtml=!0}if((i.checkHtml===!0&&i.editor=="isRte_Full"?(i.SelectedMode="html",i.SelectedText=XenForo.QuoteME.getSelectedTextHtml()):(i.SelectedMode="text",i.SelectedText=XenForo.QuoteME.getSelectedText()),!i.SelectedText)||i.Mode!="text"&&i.SelectedText.match(/<(\w+)(?:[^>]+?)?><\/\1>|<embed[^>]+?>/i))return!1;i.Author=n(t).parents(".message").attr("data-author"),i.MessageID=n(t).parents(".message").attr("id"),i.AuthorID=n(t).parents(".message").attr("data-author-id"),i.AuthorID=i.AuthorID?", member: "+i.AuthorID:"",i.MessageID.match(/post-/i)?(i.MessageType="post",i.MessageID=i.MessageID.replace(/post-/i,"")):i.MessageID.match(/message-/i)&&(i.MessageType="convMessage",i.MessageID=i.MessageID.replace(/message-/i,""))},execute:function(n){var t=XenForo.QuoteME;t.HtmlMode==1&&(n=n.replace(/^<p>([\s\S]+)<\/p>$/i,"$1")),n=t.Author&&t.MessageID&&t.MessageType?'[quote="'+t.Author+", "+t.MessageType+": "+t.MessageID+t.AuthorID+'"]'+n+"[/quote]":"[quote]"+n+"[/quote]",t.SelectedText=n,console.info("Editor mode: "+t.editor+", Text mode: "+t.Mode);switch(t.editor){case"isRte_Bbcode":t.RTE_BBcodeEditor();break;case"isRte_Full":t.RTE_TinyMCE();break;case"notRte":t.notRTE_BBcodeEditor()}},notRTE_BBcodeEditor:function(){var t=this;$editor=n(".textCtrl.MessageEditor"),$editor.val($editor.val()+"\r\n"+t.SelectedText)},RTE_BBcodeEditor:function(){var t=this;$editor=n(".bbCodeEditorContainer").find("textarea.textCtrl"),$editor.val($editor.val()+"\r\n"+t.SelectedText)},RTE_TinyMCE:function(){var n=this,t="<p><br /></p>",i;if(tinyMCE.isIE&&(t="<p>&nbsp;</p>"),i=t,!tinyMCE.activeEditor)return console.info("Error: TinyMCE is not loaded"),!1;n.Content=tinyMCE.activeEditor.getContent(),n.Content||(t=""),n.HtmlMode==0&&(n.SelectedText=XenForo.QuoteME.escapeHtml(n.SelectedText,"space")),tinyMCE.execInstanceCommand("ctrl_message_html","mceInsertContent",!1,t+"<p>"+n.SelectedText+"</p>"+i)},unSelect:function(){i.selection?i.selection.empty():t.getSelection&&t.getSelection().removeAllRanges()},getSelectedText:function(){return t.getSelection?t.getSelection().toString():i.getSelection?i.getSelection():i.selection?i.selection.createRange().text:void 0},getSelectedTextHtml:function(){var e=this,n,f,r,o,u;if(typeof t.getSelection!="undefined"){if(n=t.getSelection(),n.rangeCount){for(f=i.createElement("div"),r=0,o=n.rangeCount;r<o;++r)f.appendChild(n.getRangeAt(r).cloneContents());return e.Mode=="htmlwrap"&&n.anchorNode.parentNode.outerHTML?(u=n.anchorNode.parentNode.parentElement.outerHTML.replace(/(^<[^>]+?>)([\s\S]+)(<[^>]+?>$)/,"$1{target}$3"),u.replace("{target}",f.innerHTML)):f.innerHTML}}else if(typeof i.selection!="undefined"&&i.selection.type=="Text")return e.Mode=="htmlwrap"&&i.selection.createRange().parentElement().outerHTML?(u=i.selection.createRange().parentElement().outerHTML.replace(/(<[^>]+?>)([\s\S]+)(<[^>]+?>)/,"$1{target}$3"),u.replace("{target}",i.selection.createRange().htmlText)):i.selection.createRange().htmlText},rawHtml2cleanHtml:function(n){return XenForo.QuoteME.execute(n.tinyCode),!1},escapeHtml:function(n,t){return t!="onlyspace"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),(t=="space"||t=="onlyspace")&&(n=n.replace(/\t/g,"    ").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n}},XenForo.register(".messageContent","XenForo.QuoteME.init")}(jQuery,this,document);