/*QuoteME (2.1.0) by Cedric CLAERHOUT - Licence: CC by*/
if(typeof Sedo=="undefined")var Sedo={};!function(n,t,i,r){function u(n,t){XenForo.register(n,t)}Sedo.QuoteME={isOn:!0,isTrans:!1,QM:"#QuoteMe",QMT:"#QuoteMeTrigger",QME:"#QuoteMeEl",editorID:"ctrl_message_html",allowContent:".messageContent",isRte:!1,isRteBbCode:!1,isTinyMCE:!1,isRedactor:!1,editorType:"notRte",redactor:"",srcType:"txt",init:function(t){var i=Sedo.QuoteME,h=n(i.QM),e=n.proxy(i,"_initPressDown"),o=n.proxy(i,"_initPressUp"),s=n.proxy(i,"_initQmClick"),r,u,f;i.$element=t,i.eventTypeDown=null,r="mousedown",n("body:not("+i.QM+")").unbind(r,e).bind(r,e),i.eventTypeUp=null,u="qm_ready mouseup",t.not(i.QM).unbind(u,o).bind(u,o),f="click",h.unbind(f,s).bind(f,s)},_bindTouch:function(t){var f=this,i="touchstart",u=n.proxy(f,"_initPressDown"),e=n("body:not("+f.QM+")");t==r||t?e.unbind(i,u).bind(i,u):e.unbind(i,u)},_initPressDown:function(t){var u=this,h=n(t.target).parents(u.allowContent).length;if(u.isOn&&t.target.id!="QuoteMe"&&(u.eventTypeDown==r||u.eventTypeDown==t.type)){u.eventTypeDown=t.type;var f=n(u.QM),o=t.type=="mousedown",e=t.type=="touchstart",s=o&&t.which==1,c=o&&t.which!=1;if(u.getSelectedText(),u.SelectedText&&(s||e)&&u.unSelect(),e&&u.addEventSupport&&h&&(u._moveReset(),u.lastTouch=t,u.selChangeActivated!=r&&u.selChangeActivated||(i.addEventListener("selectionchange",u._touchSelec,!1),u.selChangeActivated=!0)),f.is(":visible")&&(s||e)){u.unSelect(),f.hide();return}if(c){f.hide();return}}},_initPressUp:function(t){var i=this,a,f,v,y,s,o,c,b;if(i.isOn){var u=n(i.QM),w=t.type=="mouseup",p=t.type=="qm_ready",k=w&&t.which==1,d=w&&t.which!=1,e=u.data("pos"),h="touch",l=t.currentTarget;if(i.eventTypeUp==r||i.eventTypeUp==t.type){if(i.eventTypeUp=t.type,p&&i.addEventSupport){if(a=i.selectionHasChanged,f=i.lastTouch,!f||f.target==r)return;if(v=n(f.target).parents(i.allowContent).length,!v)return;if(e=h,!a||i.SelectedText==r){u.hide();return}l=f.target}if(u.is(":hidden")&&(k||p)){if(y=i.config(l),y===!1){u.hide();return}if(e=="absfix")if(s=n(t.target).parents(i.allowContent).position(),o=n(t.target).parents(i.allowContent).offset(),o==null||s==null)e="fb";else{c=Math.round(t.pageY-(o.top-s.top))+1+"px",b=t.pageX+"px",u.show().css({position:"absolute",left:b,top:c});return}e=="abs"?u.css({position:"absolute",left:t.pageX+1+"px",top:t.pageY+1+"px"}):e==h?u.addClass(h):u.css({position:"fixed",left:t.clientX+1+"px",top:t.clientY+1+"px"}),u.show();return}d}}},_initQmClick:function(t){t.preventDefault();var i=this,r=n(i.QM);i.isOn&&(i.SelectedMode=="txt"?i.execute(i.SelectedText):i.SelectedText&&XenForo.ajax("index.php?quoteme/to-tiny",{htmlraw:i.SelectedText},n.proxy(i,"rawHtml2cleanHtml")),r.is(":visible")&&r.hide())},_touchSelec:function(){var i=Sedo.QuoteME,r=n(i.QM),u=i.SelectedText;if(i.getSelection(),r.is(":visible")&&!i.SelectedText&&u){i.SelectedText=u;return}r.hide(),i.SelectedText&&i.SelectedText.length>1&&(i.selectionHasChanged=!0,i.$element.trigger("qm_ready"))},_moveReset:function(n){var t=this;n==!0&&(i.removeEventListener("selectionchange",t._touchSelec,!1),t.selChangeActivated=!1),t.selectionHasChanged=!1},getParams:function(){var t=this,e=n("#"+t.editorID),f=e.data("redactor"),u;t.addEventSupport=i.addEventListener!=r,typeof tinyMCE!="undefined"&&(this.isTinyMCE=!0,this.isRte=!0),f!==r&&f!==null&&(this.isRedactor=!0,this.redactor=f,this.isRte=!0),this.isRteBbCode=this.isRte==!0&&e.attr("disabled")?!0:!1,this.isRte==!0&&(this.editorType=this.isRteBbCode==!0?"rteBB":"rteFull"),this.srcType=this.editorType=="rteFull"?"html":"txt",u=n(t.QM),t.Mode=u.data("mode"),t.HtmlMode=0,t.Mode!="QmText"&&(t.HtmlMode=parseInt(u.data("html"))),t.isTrans=parseInt(u.data("trans"))?!0:!1},config:function(t){var i=this,u;i.getParams();switch(i.Mode){case"QmText":i.Mode="txt",i.checkHtml=!1;break;case"QmHtml":i.Mode="html",i.checkHtml=!0;break;default:i.Mode="htmlwrap",i.checkHtml=!0}return(i.getSelection(),!i.SelectedText)?!1:i.Mode!="txt"&&i.SelectedText.match(/<(\w+)(?:[^>]+?)?><\/\1>|<embed[^>]+?>/i)?!1:(u=n(t).parents(".message"),i.Author=u.data("author"),i.MessageID=u.attr("id"),i.AuthorID=u.attr("data-author-id"),i.AuthorID=i.AuthorID?", member: "+i.AuthorID:"",i.MessageID==r?(i.MessageType="",i.MessageID=""):i.MessageID.match(/post-/i)?(i.MessageType="post",i.MessageID=i.MessageID.replace(/post-/i,"")):i.MessageID.match(/message-/i)&&(i.MessageType="convMessage",i.MessageID=i.MessageID.replace(/message-/i,"")),!0)},getSelection:function(){var n=this;n.checkHtml===!0&&n.editorType=="rteFull"?(n.SelectedMode="html",n.SelectedText=n.getSelectedTextHtml()):(n.SelectedMode="txt",n.SelectedText=n.getSelectedText())},execute:function(n){var t=this;t.HtmlMode==1&&(n=n.replace(/^<p>([\s\S]+)<\/p>$/i,"$1")),n=t.Author&&t.MessageID&&t.MessageType?'[quote="'+t.Author+", "+t.MessageType+": "+t.MessageID+t.AuthorID+'"]'+n+"[/quote]":"[quote]"+n+"[/quote]",t.SelectedText=n,t.isTrans?t.transMode():(t.prepareSel(),t.edDispatcher())},edDispatcher:function(){var n=this;console.info("Editor mode: "+n.editorType+", Text mode: "+n.Mode);switch(n.editorType){case"rteBB":n.RTE_BBcodeEditor();break;case"rteFull":n.RTE_Wysiwyg();break;case"notRte":n.notRTE_BBcodeEditor()}},transMode:function(){var t=this,i=t.getObjQM(),u=t.SelectedText,r=1,f=t.editorType=="rteFull"?"html":"txt";i?r=t.getObjIdx(i):i={},i[r]={data:u,type:t.srcType},t.setObjQM(i),n(t.QMT).parent().show(),n(t.QME).text(r)},transAction:function(){var t=this,i,r;if(t.getParams(),i=t.getObjQM(),r="",!i){alert(n(t.QMT).data("timeup")),n(t.QMT).hide();return}n.each(i,function(n,i){t.SelectedText=i.data,t.prepareSel(i.type),r+=t.SelectedText}),t.SelectedText=r,t.edDispatcher(),n(t.QMT).parent().hide(),t.killObjQM()},prepareSel:function(n){var i=this,t=i.SelectedText,o=i.srcType,u,e,f;if(n===r&&(n=o),o=="txt"){n!="txt"&&(t=t.replace(/<[^>]+>/ig,""),t=i.unescapeHtml(t)),$editor=i.getBbCodeEditor(),f=$editor.val(),u=f?"\r\n":"",i.SelectedText=u+t+"\r\n";return}this.isTinyMCE&&(u=tinyMCE.isIE?"<p>&nbsp;</p>":"<p><br /></p>",e=u,f=tinyMCE.activeEditor.getContent()),this.isRedactor&&(u=this.redactor.browser("msie")?"<p>&nbsp;</p>":"<p><br /></p>",e=u,f=this.redactor.getCode()),f=f.replace(/<[^>]+>|&nbsp;/ig,""),f||(u=""),i.HtmlMode==0&&n=="html"&&(t=i.escapeHtml(t)),n!="html"&&(t=i.escapeHtml(t)),i.SelectedText=u+"<p>"+t+"</p>"+e},notRTE_BBcodeEditor:function(){$editor=this.getBbCodeEditor(),$editor.val($editor.val()+this.SelectedText)},RTE_BBcodeEditor:function(){$editor=this.getBbCodeEditor(),$editor.val($editor.val()+this.SelectedText)},RTE_Wysiwyg:function(){var n=this,i=n.editorID,t=n.SelectedText,r;n.isTinyMCE?tinyMCE.majorVersion>3?(r={skip_focus:!0},tinyMCE.EditorManager.get(i).execCommand("mceInsertContent",!1,t,r)):tinyMCE.getInstanceById(i).execCommand("mceInsertContent",!1,t):n.isRedactor&&(n.redactor.focus(!0),n.redactor.insertHtml(t))},getBbCodeEditor:function(t){var i=this,r=t||i.editorType;switch(r){case"rteBB":return n(".bbCodeEditorContainer").find("textarea.textCtrl");case"notRte":return n(".textCtrl.MessageEditor");default:return console.info("Bb Editor not found"),n()}},unSelect:function(){i.selection?i.selection.empty():t.getSelection&&t.getSelection().removeAllRanges()},getSelectedText:function(){return t.getSelection?t.getSelection().toString():i.getSelection?i.getSelection():i.selection?i.selection.createRange().text:void 0},getSelectedTextHtml:function(){var o=this,n,u,f,s,e;if(t.getSelection!=r){if(n=t.getSelection(),n.rangeCount){for(u=i.createElement("div"),f=0,s=n.rangeCount;f<s;++f)u.appendChild(n.getRangeAt(f).cloneContents());return o.Mode=="htmlwrap"&&n.anchorNode.parentNode.outerHTML?(e=n.anchorNode.parentNode.parentElement.outerHTML.replace(/(^<[^>]+?>)([\s\S]+)(<[^>]+?>$)/,"$1{target}$3"),e.replace("{target}",u.innerHTML)):u.innerHTML}}else if(i.selection!=r&&i.selection.type=="Text")return o.Mode=="htmlwrap"&&i.selection.createRange().parentElement().outerHTML?(e=i.selection.createRange().parentElement().outerHTML.replace(/(<[^>]+?>)([\s\S]+)(<[^>]+?>)/,"$1{target}$3"),e.replace("{target}",i.selection.createRange().htmlText)):i.selection.createRange().htmlText},rawHtml2cleanHtml:function(n){this.execute(n.tinyCode);return},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"),t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)</p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n},menuInit:function(i){var u=Sedo.QuoteME,f,o=i.data("title"),s=i.data("off"),e;if(u.getParams(),u.disableXenQuote(i),i.data("show")||XenForo.isTouchBrowser())u.isOn=!1,n(t).load(n.proxy(u,"redactorTouchFix"));else return;if(i.show().click(function(n){n.preventDefault(),i.hasClass("off")?(i.removeClass("off").addClass("on"),u.isOn=!0,u._bindTouch()):(i.removeClass("on").addClass("off"),u.isOn=!1,u._bindTouch(!1))}),e=i.data("tooltip"),e!==r)e.onBeforeShow(function(){f=i.hasClass("off")?o:s,this.getTip().text(f)})},disableXenQuote:function(t){var i=function(t){t.preventDefault(),n("#QuickReply").data("QuickReply").scrollAndFocus()};t.attr("dxq")&&(n("a.ReplyQuote, a.MultiQuote").unbind("click").bind("click",i),XenForo.QuickReplyTrigger=function(n){n.click(function(n){i(n)})})},redactorTouchFix:function(n){var n=this,i,r,t;if(n.isRedactor){i=n.redactor,r=i.$editor;r.on("focus click",function(){t&&(clearTimeout(t),t=null),n._bindTouch(!1)}).on("blur",function(){t=setTimeout(function(){n.isOn&&n._bindTouch()},200)})}},getObjQM:function(){return n.jStorage.get("quoteme",!1)},setObjQM:function(t){n.jStorage.set("quoteme",t,{TTL:6e5})},killObjQM:function(){n.jStorage.deleteKey("quoteme")},getObjIdx:function(t){var i=1;return n.each(t,function(){i++}),i},transTrigger:function(i){var r=Sedo.QuoteME,u,f,e;($QM=n(r.QM),r.isTrans=parseInt($QM.data("trans")),r.isTrans)&&(u=r.getObjQM(),u!==!1&&(i.trigger("click"),f=function(){n("#toggleMeMenu").trigger("click")},n(t).load(f),e=r.getObjIdx(u),i.parent().show(),n(r.QME).text(e-1)),i.click(function(n){n.preventDefault(),r.transAction()}))}};var f="Sedo.QuoteME";u("#toggleMeMenu",f+".menuInit"),u("#QuoteMeTrigger",f+".transTrigger"),u(".messageContent",f+".init"),u(".quoteMeContent",f+".init")}(jQuery,this,document);