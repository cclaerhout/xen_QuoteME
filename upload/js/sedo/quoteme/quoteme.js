/*QuoteME (1.6) by Cédric CLAERHOUT - Licence: CC by*/
if(typeof Sedo=="undefined")var Sedo={};!function(n,t,i){Sedo.QuoteME={isOn:!0,isTrans:!1,QM:"#QuoteMe",QMT:"#QuoteMeTrigger",QME:"#QuoteMeEl",init:function(t){var i=Sedo.QuoteME;$QM=n(i.QM),n("body:not("+i.QM+")").unbind("mousedown").bind("mousedown",function(n){if(i.isOn&&(i.getSelectedText(),i.SelectedText&&n.which==1&&i.unSelect(),n.target.id!="QuoteMe")){if($QM.is(":visible")&&n.which==1){i.unSelect(),$QM.hide();return}if(n.which!=1){$QM.hide();return}}}),t.not(i.QM).unbind("mouseup").bind("mouseup",function(t){var s,f,r,u,o,e;if(i.isOn){if($QM.is(":hidden")&&t.which==1){if(s=i.config(this),s===!1){$QM.hide();return}if(f=$QM.data("pos"),f=="absfix"){if(r=n(t.target).parents(".messageContent").position(),u=n(t.target).parents(".messageContent").offset(),u==null||r==null)return;o=Math.round(t.pageY-(u.top-r.top))+1+"px",e=t.pageX+"px",$QM.show().css({position:"absolute",left:e,top:o})}else f=="abs"?$QM.show().css({position:"absolute",left:t.pageX+1+"px",top:t.pageY+1+"px"}):$QM.show().css({position:"fixed",left:t.clientX+1+"px",top:t.clientY+1+"px"});return}t.which!=1}}),$QM.unbind("click").bind("click",function(){i.SelectedMode=="text"?i.execute(i.SelectedText):i.SelectedText&&XenForo.ajax("index.php?quoteme/to-tiny",{htmlraw:i.SelectedText},i.rawHtml2cleanHtml),$QM.hide();return})},getParams:function(){var t=this;t.editor="notRte",typeof tinyMCE!="undefined"&&($bbcodeEditor=n(".bbCodeEditorContainer"),t.editor=$bbcodeEditor.length!=0?"rteBB":"rteFull"),t.srcType=t.editor=="rteFull"?"html":"txt",$QM=n(t.QM),t.Mode=$QM.data("mode"),t.Mode!="QmText"&&(t.HtmlMode=parseInt($QM.data("html"))),t.isTrans=parseInt($QM.data("trans"))?!0:!1},config:function(t){var i=this;i.getParams();switch(i.Mode){case"QmText":i.Mode="text",i.checkHtml=!1;break;case"QmHtml":i.Mode="html",i.checkHtml=!0;break;default:i.Mode="htmlwrap",i.checkHtml=!0}if((i.checkHtml===!0&&i.editor=="rteFull"?(i.SelectedMode="html",i.SelectedText=i.getSelectedTextHtml()):(i.SelectedMode="text",i.SelectedText=i.getSelectedText()),!i.SelectedText)||i.Mode!="text"&&i.SelectedText.match(/<(\w+)(?:[^>]+?)?><\/\1>|<embed[^>]+?>/i))return!1;i.Author=n(t).parents(".message").data("author"),i.MessageID=n(t).parents(".message").attr("id"),i.AuthorID=n(t).parents(".message").attr("data-author-id"),i.AuthorID=i.AuthorID?", member: "+i.AuthorID:"",i.MessageID.match(/post-/i)?(i.MessageType="post",i.MessageID=i.MessageID.replace(/post-/i,"")):i.MessageID.match(/message-/i)&&(i.MessageType="convMessage",i.MessageID=i.MessageID.replace(/message-/i,""))},execute:function(n){var t=Sedo.QuoteME;t.HtmlMode==1&&(n=n.replace(/^<p>([\s\S]+)<\/p>$/i,"$1")),n=t.Author&&t.MessageID&&t.MessageType?'[quote="'+t.Author+", "+t.MessageType+": "+t.MessageID+t.AuthorID+'"]'+n+"[/quote]":"[quote]"+n+"[/quote]",t.SelectedText=n,t.isTrans?t.transMode():(t.prepareSel(),t.edDispatcher())},edDispatcher:function(){var n=this;console.info("Editor mode: "+n.editor+", Text mode: "+n.Mode);switch(n.editor){case"rteBB":n.RTE_BBcodeEditor();break;case"rteFull":n.RTE_TinyMCE();break;case"notRte":n.notRTE_BBcodeEditor()}},transMode:function(){var t=this,i=t.getObjQM(),u=t.SelectedText,r=1,f=t.editor=="rteFull"?"html":"txt";i?r=t.getObjIdx(i):i={},i[r]={data:u,type:t.srcType},t.setObjQM(i),n(t.QMT).parent().show(),n(t.QME).text(r)},transAction:function(){var t=this,r,i;(t.getParams(),r=t.getObjQM(),i="",r)&&(n.each(r,function(n,r){t.SelectedText=r.data,t.prepareSel(r.type),i+=t.SelectedText}),t.SelectedText=i,t.edDispatcher(),n(t.QMT).parent().hide(),t.killObjQM())},prepareSel:function(n){var i=this,t=i.SelectedText,u=i.srcType;if(typeof n=="undefined"&&(n=u),u=="txt"){n!="txt"&&(t=t.replace(/<[^>]+>/ig,""),t=i.unescapeHtml(t)),i.SelectedText="\r\n"+t+"\r\n";return}var r=tinyMCE.isIE?"<p>&nbsp;</p>":"<p><br /></p>",e=r,f=tinyMCE.activeEditor.getContent();f||(r=""),i.HtmlMode==0&&n=="html"&&(t=i.escapeHtml(t)),n!="html"&&(t=i.escapeHtml(t)),i.SelectedText=r+"<p>"+t+"</p>"+e},notRTE_BBcodeEditor:function(){$editor=n(".textCtrl.MessageEditor"),$editor.val($editor.val()+this.SelectedText)},RTE_BBcodeEditor:function(){$editor=n(".bbCodeEditorContainer").find("textarea.textCtrl"),$editor.val($editor.val()+this.SelectedText)},RTE_TinyMCE:function(){var n=this;if(!tinyMCE.activeEditor)return console.info("Error: TinyMCE is not loaded"),!1;tinyMCE.execInstanceCommand("ctrl_message_html","mceInsertContent",!1,n.SelectedText)},unSelect:function(){i.selection?i.selection.empty():t.getSelection&&t.getSelection().removeAllRanges()},getSelectedText:function(){return t.getSelection?t.getSelection().toString():i.getSelection?i.getSelection():i.selection?i.selection.createRange().text:void 0},getSelectedTextHtml:function(){var e=this,n,f,r,o,u;if(typeof t.getSelection!="undefined"){if(n=t.getSelection(),n.rangeCount){for(f=i.createElement("div"),r=0,o=n.rangeCount;r<o;++r)f.appendChild(n.getRangeAt(r).cloneContents());return e.Mode=="htmlwrap"&&n.anchorNode.parentNode.outerHTML?(u=n.anchorNode.parentNode.parentElement.outerHTML.replace(/(^<[^>]+?>)([\s\S]+)(<[^>]+?>$)/,"$1{target}$3"),u.replace("{target}",f.innerHTML)):f.innerHTML}}else if(typeof i.selection!="undefined"&&i.selection.type=="Text")return e.Mode=="htmlwrap"&&i.selection.createRange().parentElement().outerHTML?(u=i.selection.createRange().parentElement().outerHTML.replace(/(<[^>]+?>)([\s\S]+)(<[^>]+?>)/,"$1{target}$3"),u.replace("{target}",i.selection.createRange().htmlText)):i.selection.createRange().htmlText},rawHtml2cleanHtml:function(n){return Sedo.QuoteME.execute(n.tinyCode),!1},unescapeHtml:function(n,t){n=n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'"),t=="noBlank"&&(n=n.replace(/	/g,"\t").replace(/&nbsp;/g,"  ").replace(/<\/p>\n<p>/g,"\n"));var i=new RegExp("^<p>([\\s\\S]+)</p>$","i");return i.test(n)&&(n=n.match(i),n=n[1]),n},escapeHtml:function(n,t){return t!=="onlyBlank"&&(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),t!=="noBlank"&&(n=n.replace(/\t/g,"\t").replace(/ /g,"&nbsp;").replace(/\n/g,"</p>\n<p>")),n},menuInit:function(n){var t=Sedo.QuoteME,i;t.menuOn=n.data("title"),t.menuOff=n.data("off"),t.isOn=!1;n.show().click(function(){n.hasClass("off")?(n.removeClass("off").addClass("on"),t.isOn=!0):(n.removeClass("on").addClass("off"),t.isOn=!1)}).data("tooltip").onBeforeShow(function(){i=n.hasClass("off")?t.menuOn:t.menuOff,this.getTip().text(i)})},getObjQM:function(){return n.jStorage.get("quoteme",!1)},setObjQM:function(t){n.jStorage.set("quoteme",t,{TTL:6e5})},killObjQM:function(){n.jStorage.deleteKey("quoteme")},getObjIdx:function(t){var i=1;return n.each(t,function(){i++}),i},transTrigger:function(t){var i=Sedo.QuoteME,r,u;($QM=n(i.QM),i.isTrans=parseInt($QM.data("trans"))?!0:!1,i.isTrans)&&(r=i.getObjQM(),r!==!1&&(t.trigger("click"),u=i.getObjIdx(r),t.parent().show(),n(i.QME).text(u)),t.click(function(){i.transAction()}))}},XenForo.isTouchBrowser()||(XenForo.register("#toggleMeMenu","Sedo.QuoteME.menuInit"),XenForo.register("#QuoteMeTrigger","Sedo.QuoteME.transTrigger"),XenForo.register(".messageContent","Sedo.QuoteME.init"))}(jQuery,this,document);